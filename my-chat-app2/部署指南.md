# LoRA 聊天系统部署指南（多设备访问）

## 📋 前置要求

1. **Python 3.7+** 已安装
2. **Node.js 和 npm** 已安装
3. **所有设备连接到同一个WiFi热点**
4. **LoRA模型文件**已准备好（在 `backend/Core.py` 中配置路径）

---

## 🚀 完整启动流程

### **第一步：构建前端静态文件**

在项目根目录（`D:\Task_design`）下，打开**第一个终端**：

```bash
cd my-chat-app2
npm run build
```

**成功标志：** 你会看到：
```
vite v7.x.x building for production...
✓ built in xxx ms
```

构建完成后，会生成 `dist/` 文件夹，里面包含静态文件。

---

### **第二步：启动后端服务器（LoRA系统）**

在项目根目录（`D:\Task_design`）下，打开**第二个终端**：

```bash
python backend/Websocket.py
```

**成功标志：** 你会看到：
```
[server_ws] booting...
[server_ws] starting ws://0.0.0.0:8765
[log] 实验日志将保存到: experiment_logs/lora_experiment_YYYYMMDD_HHMMSS.csv
Loading tokenizer...
Loading base regression model...
Loading persona LoRA...
Loading scene LoRA...
Loading topic LoRA...
Regression model with 3 LoRA heads loaded on: cuda
[gpu_worker] started
```

**重要：**
- ✅ 后端监听在 `0.0.0.0:8765`，这意味着接受所有网络接口的连接
- ✅ 保持这个终端窗口打开，不要关闭
- ✅ 记录你的电脑IP地址（后续会用到）

---

### **第三步：获取服务器IP地址**

#### **方法1：Windows PowerShell**
```powershell
ipconfig | Select-String -Pattern "IPv4"
```

找到连接到WiFi热点的网络适配器的IPv4地址，例如：`192.168.1.100`

#### **方法2：命令提示符**
```cmd
ipconfig
```

找到 "无线局域网适配器 WLAN" 或 "以太网适配器" 的IPv4地址

---

### **第四步：启动静态文件服务器**

在项目根目录（`D:\Task_design`）下，打开**第三个终端**：

#### **选项A：使用 npx serve（推荐，无需安装）**

```bash
cd my-chat-app2
npx serve dist -l 5173 --cors
```

#### **选项B：全局安装 serve（如果选项A失败）**

```bash
npm install -g serve
cd my-chat-app2
serve dist -l 5173 --cors
```

**成功标志：** 你会看到：
```
  ┌─────────────────────────────────────┐
  │                                     │
  │   Serving!                          │
  │                                     │
  │   Local:    http://localhost:5173   │
  │   Network:  http://192.168.1.100:5173 │
  │                                     │
  └─────────────────────────────────────┘
```

**重要：**
- ✅ 记录 Network 地址（例如：`http://192.168.1.100:5173`）
- ✅ 这个地址就是其他设备需要访问的地址
- ✅ 保持这个终端窗口打开

---

### **第五步：在其他设备上访问**

#### **在同一个网络的任何设备上：**

1. **打开浏览器**（Chrome、Safari、Edge等）
2. **访问**：`http://[你的IP地址]:5173`
   - 例如：`http://192.168.1.100:5173`
3. **开始使用**：填写个人信息，进入聊天室

**注意：**
- ✅ 每个设备会自动分配一个**随机数字编号（1-100）**
- ✅ 不同设备会有不同的编号，便于识别
- ✅ 所有设备都在同一个聊天室中，可以看到彼此的消息

---

## 🔧 故障排查

### **问题1：其他设备无法访问前端**

**解决方案：**
1. **检查防火墙**：
   - Windows：允许端口 5173 通过防火墙
   - 或临时关闭防火墙测试

2. **检查IP地址**：
   - 确保设备连接到同一个WiFi热点
   - 确保IP地址正确（不是 `127.0.0.1` 或 `localhost`）

3. **使用 `--host` 参数**（如果使用Vite开发模式）：
   ```bash
   npm run dev -- --host
   ```

### **问题2：WebSocket连接失败**

**解决方案：**
1. **检查后端是否运行**：确认 `python backend/Websocket.py` 正在运行
2. **检查端口**：确认后端监听在 `8765` 端口
3. **检查IP地址**：前端自动使用 `window.location.hostname`，应该自动适配

### **问题3：前端显示连接错误**

**解决方案：**
1. **检查浏览器控制台**：按 `F12` 查看错误信息
2. **确认后端地址**：前端代码中 `WS_URL = ws://${window.location.hostname}:8765`
   - 如果访问 `http://192.168.1.100:5173`，WebSocket会自动连接到 `ws://192.168.1.100:8765`

---

## 📱 多设备测试流程

1. **设备A（主机）**：
   - 运行后端：`python backend/Websocket.py`
   - 运行静态服务器：`npx serve dist -l 5173 --cors`
   - 访问：`http://localhost:5173` 或 `http://[IP]:5173`

2. **设备B（其他设备）**：
   - 连接到同一个WiFi热点
   - 访问：`http://[主机IP]:5173`
   - 例如：`http://192.168.1.100:5173`

3. **验证**：
   - 两个设备进入聊天室后，会看到彼此的消息
   - 每个设备会有不同的数字编号
   - Agent的响应会广播到所有设备

---

## 📊 实验数据收集

### **CSV日志文件**

实验数据会自动保存到：
```
experiment_logs/lora_experiment_YYYYMMDD_HHMMSS.csv
```

**CSV包含以下列：**
1. 时间戳
2. 序号
3. 发言者类型（用户/Agent）
4. 编号（1-100的随机数字）
5. 用户ID
6. 说话内容
7. **最终Willingness**（三个LoRA分数的平均值）
8. **Persona分数**（人物信息LoRA）
9. **Scene分数**（场景信息LoRA）
10. **Topic分数**（话题信息LoRA）
11. 是否触发插话
12. Agent策略
13. Agent插话内容
14. Agent编号

---

## 🛑 停止服务

1. **停止静态服务器**：在运行 `npx serve` 的终端按 `Ctrl+C`
2. **停止后端服务器**：在运行 `python backend/Websocket.py` 的终端按 `Ctrl+C`

---

## 💡 快速启动脚本（可选）

你可以创建两个批处理文件来快速启动：

### **start-backend.bat**
```batch
@echo off
cd /d D:\Task_design
python backend/Websocket.py
pause
```

### **start-frontend.bat**
```batch
@echo off
cd /d D:\Task_design\my-chat-app2
npx serve dist -l 5173 --cors
pause
```

双击这两个文件即可快速启动服务。

---

## 📝 注意事项

1. **每次代码修改后**，需要重新运行 `npm run build` 来构建最新的前端代码
2. **开发模式**：如果你想实时看到代码变化，可以使用 `npm run dev -- --host`（但需要重新配置端口）
3. **端口冲突**：如果 5173 端口被占用，可以更改端口：`npx serve dist -l 8080 --cors`
4. **后端端口**：LoRA系统使用 `8765` 端口，不要更改（前端代码已配置）
