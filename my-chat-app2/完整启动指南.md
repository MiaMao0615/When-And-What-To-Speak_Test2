# 🚀 LoRA 聊天系统完整启动指南

## 📌 快速开始（3步启动）

### **步骤1：构建前端**
双击运行：`构建前端.bat`
- 或手动运行：`npm run build`

### **步骤2：启动后端**
双击运行：`启动后端.bat`
- 或手动运行：`python backend/Websocket.py`

### **步骤3：启动前端服务**
双击运行：`启动前端服务.bat`
- 或手动运行：`npx serve dist -l 5173 --cors`

---

## 📱 多设备访问设置

### **1. 获取服务器IP地址**

在Windows PowerShell或命令提示符中运行：
```bash
ipconfig
```

找到连接到WiFi热点的网络适配器的**IPv4地址**，例如：
```
无线局域网适配器 WLAN:
   IPv4 地址 . . . . . . . . . . . : 192.168.1.100
```

### **2. 在服务器（主机）上访问**

打开浏览器，访问：
```
http://localhost:5173
```
或
```
http://192.168.1.100:5173
```

### **3. 在其他设备上访问**

1. 确保设备连接到**同一个WiFi热点**
2. 打开浏览器，访问：
```
http://192.168.1.100:5173
```
（将 `192.168.1.100` 替换为你的实际IP地址）

---

## ✅ 验证多设备连接

### **检查点：**

1. ✅ **后端服务器运行中**
   - 终端显示：`[server_ws] starting ws://0.0.0.0:8765`
   - 终端显示：`[gpu_worker] started`

2. ✅ **前端服务器运行中**
   - 终端显示：`Serving!` 和 `Network: http://192.168.x.x:5173`

3. ✅ **设备可以访问前端**
   - 浏览器可以打开前端页面

4. ✅ **WebSocket连接成功**
   - 打开浏览器开发者工具（F12）
   - 查看 Console，应该看到连接成功的信息

5. ✅ **不同设备有不同的编号**
   - 设备A进入聊天室后，显示：`您的编号：#42`
   - 设备B进入聊天室后，显示：`您的编号：#17`
   - 每个设备会随机分配1-100之间的数字编号

---

## 🔧 常见问题解决

### **问题1：其他设备无法访问前端页面**

**原因：** 防火墙阻止了端口5173

**解决：**
1. Windows防火墙设置：
   - 打开"Windows Defender 防火墙"
   - 点击"高级设置"
   - 点击"入站规则" → "新建规则"
   - 选择"端口" → "TCP" → "特定本地端口" → 输入 `5173`
   - 允许连接 → 完成

2. 或临时关闭防火墙测试（不推荐，仅用于测试）

### **问题2：WebSocket连接失败**

**原因：** 后端未启动或防火墙阻止了端口8765

**解决：**
1. 确认后端服务器正在运行（`python backend/Websocket.py`）
2. 打开防火墙端口8765（方法同上，端口改为8765）

### **问题3：前端显示"连接失败"或"无法连接到服务器"**

**检查：**
1. 后端服务器是否运行？
2. 防火墙是否允许端口8765？
3. 浏览器控制台（F12）是否有错误信息？

### **问题4：两个设备显示相同的编号**

**这不应该发生！** 如果发生了：
1. 刷新两个设备的页面
2. 确保两个设备都完成了"加入聊天室"的步骤
3. 检查后端日志，查看是否有错误

---

## 📊 实验数据收集

### **CSV日志文件位置：**
```
D:\Task_design\experiment_logs\lora_experiment_YYYYMMDD_HHMMSS.csv
```

### **CSV文件包含：**
- ✅ 每条用户消息
- ✅ 最终Willingness（平均值）
- ✅ Persona分数（人物信息LoRA）
- ✅ Scene分数（场景信息LoRA）
- ✅ Topic分数（话题信息LoRA）
- ✅ Agent响应（如果触发）
- ✅ 用户编号和Agent编号

### **实验结束后：**
1. 点击右侧面板的红色"结束实验"按钮
2. 点击"查看统计"按钮查看实验统计
3. CSV文件路径会在统计面板底部显示

---

## 🎯 测试流程示例

### **场景：双设备测试**

**设备A（主机，IP: 192.168.1.100）**
1. 运行后端：`python backend/Websocket.py`
2. 运行前端服务：`npx serve dist -l 5173 --cors`
3. 访问：`http://localhost:5173`
4. 填写个人信息，进入聊天室
5. 显示编号：`您的编号：#42`

**设备B（测试设备，连接到同一WiFi）**
1. 访问：`http://192.168.1.100:5173`
2. 填写个人信息，进入聊天室
3. 显示编号：`您的编号：#17`

**验证：**
- 设备A发送消息："大家好！"
- 设备B可以看到消息：`#42: 大家好！`
- 设备B发送消息："收到！"
- 设备A可以看到消息：`#17: 收到！`
- Agent响应会同时显示在两个设备上

---

## 📝 启动顺序检查清单

- [ ] 1. 构建前端：运行 `构建前端.bat` 或 `npm run build`
- [ ] 2. 启动后端：运行 `启动后端.bat` 或 `python backend/Websocket.py`
- [ ] 3. 获取IP地址：运行 `ipconfig` 查看IPv4地址
- [ ] 4. 启动前端服务：运行 `启动前端服务.bat` 或 `npx serve dist -l 5173 --cors`
- [ ] 5. 在主机访问：浏览器打开 `http://localhost:5173`
- [ ] 6. 在其他设备访问：浏览器打开 `http://[IP地址]:5173`
- [ ] 7. 验证连接：确认两个设备都能连接并看到不同的编号

---

## 💡 提示

1. **每次修改前端代码后**，需要重新运行 `npm run build`
2. **后端代码修改后**，需要重启后端服务器
3. **确保所有设备在同一个WiFi网络下**
4. **如果IP地址变化**（WiFi重连），需要更新其他设备的访问地址
5. **实验数据会自动保存**到CSV文件，无需手动操作
