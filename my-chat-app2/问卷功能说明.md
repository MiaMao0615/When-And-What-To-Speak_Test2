# 📋 问卷功能使用说明

## 🎯 功能概述

实验结束后，系统会自动进入问卷阶段。用户需要：
1. 对场景中的**每个参与者**（不包括自己）进行评分
2. 评分范围：**1-10分**
   - 1分 = 非常确定不是Agent
   - 10分 = 非常确定是Agent
3. 所有用户完成问卷后，系统会显示实验统计结果和CSV数据

---

## 📝 问卷流程

### **阶段1：实验进行中**
- 用户可以正常聊天
- 每个用户和Agent都有随机编号（1-100）

### **阶段2：实验结束 → 问卷开始**
- 主持人点击"结束实验"按钮
- **所有设备自动进入问卷界面**
- **不显示统计结果**（避免泄露答案）

### **阶段3：问卷填写**
- 每个用户看到**其他所有参与者**的列表
- 对每个参与者使用**滑块**进行评分（1-10分）
- 实时显示当前评分
- 必须为所有参与者评分后才能提交

### **阶段4：等待其他用户**
- 提交问卷后，显示等待界面
- 显示问卷进度（已完成人数 / 总人数）
- 等待所有用户完成问卷

### **阶段5：显示统计结果**
- 所有用户完成问卷后，**自动显示统计结果**
- 显示CSV文件路径
- 可以查看详细的实验数据

---

## 🎨 问卷界面说明

### **问卷卡片显示：**
```
编号 #42
昵称：张三

[滑块：1 ----●--- 10]

不是Agent              是Agent
```

### **问卷进度显示：**
```
问卷进度
已完成：3 / 5
等待其他用户...
```

---

## 📊 数据记录

### **问卷答案记录到CSV：**
```csv
时间戳,序号,发言者类型,编号,用户ID,说话内容,...
2026-01-17 22:30:00,QUESTIONNAIRE-u_abc123,问卷答案,42,u_abc123,对编号#17的Agent评分: 8.0/10,...
2026-01-17 22:30:00,QUESTIONNAIRE-u_abc123,问卷答案,42,u_abc123,对编号#58的Agent评分: 9.0/10,...
```

**CSV记录包含：**
- ✅ 每个用户的问卷答案
- ✅ 评分对象（目标编号）
- ✅ 评分值（1-10分）
- ✅ 最终Willingness（三个LoRA分数的平均值）
- ✅ Persona分数（人物信息LoRA）
- ✅ Scene分数（场景信息LoRA）
- ✅ Topic分数（话题信息LoRA）
- ✅ Agent响应和策略

---

## ⚙️ 技术实现

### **后端 (`backend/Websocket.py`)**
- 实验结束时收集所有参与者编号
- 初始化问卷状态（`questionnaire_started = True`）
- 接收问卷答案，验证格式（1-10分）
- 跟踪问卷完成进度
- 所有用户完成后，生成统计并广播结果

### **前端 (`my-chat-app2/src/App.jsx`)**
- 问卷状态管理（`questionnaireStarted`, `questionnaireCompleted`）
- 问卷界面组件（显示所有参与者，评分滑块）
- 问卷答案验证（确保所有参与者都已评分）
- 问卷进度显示（等待其他用户）
- 统计结果展示（问卷完成后）

---

## 🔄 状态流转

```
实验进行中
    ↓ (主持人点击"结束实验")
问卷阶段（questionnaire_started = true）
    ↓ (所有用户填写并提交问卷)
统计结果显示（questionnaire_completed = true）
    ↓
显示CSV数据
```

---

## 📌 注意事项

1. **必须在所有用户完成问卷后**才能看到统计结果
2. **问卷不能重复提交**（每个用户只能提交一次）
3. **必须为所有其他参与者评分**（否则无法提交）
4. **问卷答案会记录到CSV文件**中，便于后续分析
5. **Agent的真实编号不会在问卷阶段显示**，避免影响判断

---

## 🐛 故障排查

### **问题1：问卷界面没有显示参与者**

**原因：** 用户编号未正确收集

**解决：**
- 确认用户已发送`user_number`消息
- 检查后端日志：`[log] 用户编号已记录`

### **问题2：无法提交问卷**

**原因：** 未为所有参与者评分

**解决：**
- 确认已为所有其他参与者评分（1-10分）
- 检查是否有遗漏的参与者

### **问题3：问卷提交后一直等待**

**原因：** 其他用户尚未提交问卷

**解决：**
- 查看问卷进度显示
- 等待所有用户完成问卷

### **问题4：问卷完成后未显示统计结果**

**原因：** 后端统计生成失败

**解决：**
- 检查后端日志：`[questionnaire] 所有用户已完成问卷`
- 检查后端日志：`[experiment] 统计数据: ...`

---

## 💡 使用示例

### **场景：5人对话实验**

**参与者：**
- 用户1（编号：#42）
- 用户2（编号：#17）
- 用户3（编号：#58）
- 用户4（编号：#33）
- 用户5（编号：#91）
- Agent（编号：#58）

**问卷阶段：**
- 用户1需要评分：用户2、用户3、用户4、用户5、Agent（但不显示真实身份）
- 用户2需要评分：用户1、用户3、用户4、用户5、Agent
- ...以此类推

**评分示例：**
- 用户1认为编号#17是Agent的可能性：**8分**
- 用户1认为编号#58是Agent的可能性：**9分**
- 用户1认为编号#33是Agent的可能性：**3分**
- ...

**问卷完成后：**
- 显示统计结果
- 显示CSV文件路径
- CSV中包含所有用户的问卷答案
